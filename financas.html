<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portf√≥lio+</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #07090a;
  --s1:       #0f1314;
  --s2:       #161c1e;
  --s3:       #1e2729;
  --border:   #263032;
  --green:    #00f5a0;
  --blue:     #38bdf8;
  --orange:   #fb923c;
  --purple:   #a78bfa;
  --yellow:   #fbbf24;
  --red:      #f87171;
  --text:     #e2eaec;
  --muted:    #4d6b70;
  --muted2:   #2a4048;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh;}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
#auth-screen{
  min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:
    radial-gradient(circle at 15% 85%, #00f5a008 0%, transparent 45%),
    radial-gradient(circle at 85% 15%, #38bdf808 0%, transparent 45%),
    var(--bg);
}
.auth-wrap{display:flex;gap:64px;align-items:center;max-width:900px;width:100%;padding:0 24px;}
.auth-brand{flex:1;}
.auth-brand-logo{font-family:'Syne',sans-serif;font-size:52px;font-weight:800;line-height:1;color:var(--green);letter-spacing:-2px;}
.auth-brand-tagline{font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:12px;line-height:2;}
.auth-brand-feat{margin-top:40px;display:flex;flex-direction:column;gap:12px;}
.auth-feat-item{display:flex;align-items:center;gap:12px;font-size:12px;color:var(--muted);letter-spacing:.5px;}
.auth-feat-icon{width:28px;height:28px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.fi-green{background:#00f5a012;} .fi-blue{background:#38bdf812;} .fi-purple{background:#a78bfa12;}

.auth-box{
  width:380px;flex-shrink:0;background:var(--s1);border:1px solid var(--border);
  border-radius:4px;padding:40px 36px;position:relative;
}
.auth-box::after{
  content:'';position:absolute;inset:0;border-radius:4px;pointer-events:none;
  background:linear-gradient(135deg,#00f5a006 0%,transparent 60%);
}
.auth-tabs{display:flex;margin-bottom:28px;border-bottom:1px solid var(--border);}
.auth-tab{
  flex:1;background:none;border:none;color:var(--muted);font-family:'JetBrains Mono',monospace;
  font-size:11px;letter-spacing:2px;text-transform:uppercase;padding:10px;cursor:pointer;
  border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s;
}
.auth-tab.active{color:var(--green);border-bottom-color:var(--green);}
.fg{margin-bottom:18px;}
.fg label{display:block;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:7px;}
.fg input{
  width:100%;background:var(--s2);border:1px solid var(--border);color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:13px;padding:11px 13px;border-radius:3px;
  outline:none;transition:border-color .2s;
}
.fg input:focus{border-color:var(--green);}
.btn-auth{
  width:100%;background:var(--green);color:#07090a;border:none;font-family:'JetBrains Mono',monospace;
  font-size:12px;font-weight:500;letter-spacing:2px;text-transform:uppercase;padding:13px;
  border-radius:3px;cursor:pointer;transition:opacity .2s;margin-top:4px;
}
.btn-auth:hover{opacity:.85;}
.auth-err{color:var(--red);font-size:11px;margin-top:10px;text-align:center;min-height:16px;}

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
#app-screen{display:none;}
.topbar{
  background:var(--s1);border-bottom:1px solid var(--border);
  padding:14px 32px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:200;
}
.topbar-logo{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--green);letter-spacing:-1px;}
.topbar-right{display:flex;align-items:center;gap:16px;}
.topbar-user{font-size:11px;color:var(--muted);letter-spacing:1px;}
.btn-out{
  background:none;border:1px solid var(--border);color:var(--muted);font-family:'JetBrains Mono',monospace;
  font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:5px 11px;border-radius:3px;
  cursor:pointer;transition:all .2s;
}
.btn-out:hover{border-color:var(--red);color:var(--red);}

.main{max-width:1140px;margin:0 auto;padding:36px 24px;}

/* ‚îÄ‚îÄ PASTE ZONE ‚îÄ‚îÄ */
.paste-section{margin-bottom:40px;}
.section-eyebrow{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:16px;}

.paste-zone{
  background:var(--s1);border:1px solid var(--border);border-radius:4px;
  position:relative;overflow:hidden;
}
.paste-zone::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--green),var(--blue));
}

.paste-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 24px 0;
}
.paste-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;color:var(--text);}
.paste-hint{
  font-size:11px;color:var(--muted);letter-spacing:.5px;line-height:1.7;
  background:var(--s2);border:1px solid var(--border);border-radius:3px;
  padding:10px 14px;
}
.paste-hint strong{color:var(--green);}

.paste-body{padding:20px 24px 24px;display:flex;flex-direction:column;gap:16px;}

/* A grande √°rea de drop */
.drop-target{
  border:2px dashed var(--border);border-radius:4px;
  min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:8px;cursor:pointer;transition:all .25s;position:relative;
  background:var(--s2);
}
.drop-target:hover,.drop-target.drag-over{border-color:var(--green);background:#00f5a006;}
.drop-target.has-data{border-style:solid;border-color:var(--green);background:#00f5a004;}
.drop-icon{font-size:32px;opacity:.4;}
.drop-label{font-size:13px;color:var(--muted);letter-spacing:.5px;text-align:center;line-height:1.8;}
.drop-label strong{color:var(--green);}
.drop-sub{font-size:11px;color:var(--muted2);}

/* √Årea textarea oculta (recebe o paste) */
#paste-input{
  position:absolute;opacity:0;width:1px;height:1px;top:0;left:0;
}

/* Preview table */
#preview-wrap{display:none;padding:0 24px 24px;}
.preview-bar{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
}
.preview-count{font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.preview-actions{display:flex;gap:10px;}
.btn-cancel{
  background:none;border:1px solid var(--border);color:var(--muted);
  font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:1px;
  text-transform:uppercase;padding:8px 16px;border-radius:3px;cursor:pointer;transition:all .2s;
}
.btn-cancel:hover{border-color:var(--red);color:var(--red);}
.btn-save{
  background:var(--green);color:#07090a;border:none;
  font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;
  letter-spacing:1px;text-transform:uppercase;padding:8px 20px;
  border-radius:3px;cursor:pointer;transition:opacity .2s;
}
.btn-save:hover{opacity:.85;}
.btn-save:disabled{opacity:.4;cursor:not-allowed;}

.ptable{width:100%;border-collapse:collapse;}
.ptable th{
  font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);
  padding:8px 12px;text-align:left;border-bottom:1px solid var(--border);
}
.ptable td{padding:11px 12px;font-size:13px;border-bottom:1px solid var(--s3);vertical-align:middle;}
.ptable tr:last-child td{border-bottom:none;}
.ptable tr:hover td{background:var(--s2);}
.ticker-cell{font-weight:500;letter-spacing:1px;color:var(--text);}
.cotas-cell{color:var(--muted);}
.price-loading{color:var(--yellow);font-size:12px;display:flex;align-items:center;gap:6px;}
.price-ok{color:var(--green);font-weight:500;}
.price-err{color:var(--red);font-size:11px;}
.total-ok{color:var(--green);font-weight:500;}
.spin{display:inline-block;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

.manual-val-input{
  background:var(--s2);border:1px solid var(--border);color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:12px;padding:5px 8px;
  border-radius:3px;outline:none;width:110px;transition:border-color .2s;
}
.manual-val-input:focus{border-color:var(--green);}
.manual-val-input::placeholder{color:var(--muted2);}
.tipo-sel{
  background:var(--s2);border:1px solid var(--border);color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:11px;padding:5px 8px;
  border-radius:3px;outline:none;cursor:pointer;
}
.tipo-sel option{background:var(--s2);}

.badge{display:inline-block;padding:2px 9px;border-radius:2px;font-size:10px;letter-spacing:1px;text-transform:uppercase;font-weight:500;}
.b-fii{background:#38bdf812;color:var(--blue);}
.b-acoes{background:#00f5a012;color:var(--green);}
.b-etf{background:#fbbf2412;color:var(--yellow);}
.b-crypto{background:#a78bfa12;color:var(--purple);}
.b-renda-fixa{background:#fb923c12;color:var(--orange);}
.b-outro{background:#4d6b7012;color:var(--muted);}

.err-msg{color:var(--red);font-size:11px;padding:0 24px 16px;letter-spacing:.5px;}

/* ‚îÄ‚îÄ MANUAL (secund√°rio) ‚îÄ‚îÄ */
.manual-toggle{
  display:flex;align-items:center;gap:10px;cursor:pointer;
  font-size:11px;color:var(--muted);letter-spacing:1px;margin-bottom:16px;
  user-select:none;
}
.manual-toggle:hover{color:var(--text);}
.manual-toggle .arrow{transition:transform .2s;display:inline-block;}
.manual-toggle.open .arrow{transform:rotate(90deg);}
.manual-form{
  display:none;background:var(--s1);border:1px solid var(--border);
  border-radius:4px;padding:20px 24px;
}
.manual-form.open{display:block;}
.mrow{display:grid;grid-template-columns:2fr 1.2fr 1.2fr 1fr auto;gap:14px;align-items:end;}
.mrow .fg{margin:0;}
.mrow .fg input,.mrow .fg select{
  background:var(--s2);border:1px solid var(--border);color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:13px;padding:10px 12px;
  border-radius:3px;outline:none;width:100%;transition:border-color .2s;
}
.mrow .fg input:focus,.mrow .fg select:focus{border-color:var(--green);}
.btn-madd{
  background:var(--s3);border:1px solid var(--border);color:var(--green);
  font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:1px;
  text-transform:uppercase;padding:10px 16px;border-radius:3px;
  cursor:pointer;white-space:nowrap;transition:all .2s;
}
.btn-madd:hover{background:var(--green);color:#07090a;border-color:var(--green);}

/* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:36px;}
.chart-card{background:var(--s1);border:1px solid var(--border);border-radius:4px;padding:22px;}
.chart-ey{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:18px;}

/* ‚îÄ‚îÄ LISTA ‚îÄ‚îÄ */
.list-head-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.filter-wrap{display:flex;align-items:center;gap:12px;}
.filter-wrap label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.filter-wrap select{
  background:var(--s2);border:1px solid var(--border);color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:12px;padding:7px 11px;
  border-radius:3px;outline:none;
}
.list-card{background:var(--s1);border:1px solid var(--border);border-radius:4px;padding:20px;}
.list-hdr{
  display:grid;grid-template-columns:2fr 1.2fr 0.9fr 1fr 1fr 1.6fr 1.4fr auto;gap:16px;
  font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);
  padding-bottom:10px;border-bottom:1px solid var(--border);margin-bottom:4px;
}
.list-row{
  display:grid;grid-template-columns:2fr 1.2fr 0.9fr 1fr 1fr 1.6fr 1.4fr auto;gap:16px;
  padding:12px 0;border-bottom:1px solid var(--s3);font-size:13px;align-items:center;
  animation:fadeIn .3s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}
.list-row:last-child{border-bottom:none;}
.list-ticker{font-weight:500;letter-spacing:1px;}
.list-val{color:var(--green);font-weight:500;}
.btn-del{
  background:none;border:1px solid transparent;color:var(--muted);
  font-size:13px;cursor:pointer;padding:3px 7px;border-radius:3px;transition:all .2s;
}
.btn-del:hover{border-color:var(--red);color:var(--red);}
.empty{text-align:center;padding:48px 20px;color:var(--muted);font-size:12px;line-height:2.2;}
.empty strong{display:block;font-size:28px;margin-bottom:8px;opacity:.3;}
.total-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 0 0;margin-top:6px;border-top:1px solid var(--border);
}
.total-lbl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.total-num{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;color:var(--green);}

.loading-msg{text-align:center;padding:20px;color:var(--muted);font-size:12px;}

/* ‚îÄ‚îÄ se√ß√µes colaps√°veis ‚îÄ‚îÄ */
.section-body{overflow:hidden;}
.section-body.collapsed{display:none;}

/* ‚îÄ‚îÄ bot√µes de tipo de gr√°fico ‚îÄ‚îÄ */
.chart-types{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;}
.btn-ctype{
  background:none;border:1px solid var(--border);color:var(--muted);
  font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;
  padding:4px 10px;border-radius:3px;cursor:pointer;transition:all .2s;
}
.btn-ctype:hover{border-color:var(--green);color:var(--green);}
.btn-ctype.active{background:var(--green);color:#07090a;border-color:var(--green);}

/* ‚îÄ‚îÄ campo de data no paste ‚îÄ‚îÄ */
.paste-date-row{
  display:flex;align-items:center;gap:12px;padding:0 24px 16px;
}
.paste-date-row label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.paste-date-row input[type=month]{
  background:var(--s2);border:1px solid var(--border);color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:12px;padding:6px 10px;
  border-radius:3px;outline:none;transition:border-color .2s;
}
.paste-date-row input[type=month]:focus{border-color:var(--green);}
.list-hdr span{cursor:pointer;user-select:none;display:flex;align-items:center;gap:5px;transition:color .15s;}
.list-hdr span:hover{color:var(--text);}
.list-hdr span.sorted{color:var(--green);}
.sort-arrow{font-size:9px;opacity:.6;}
.group-sep{
  grid-column:1/-1;padding:6px 0 4px;
  font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:var(--muted2);border-top:1px solid var(--s3);margin-top:4px;
}
.group-sep:first-child{border-top:none;margin-top:0;}
.sinal{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:3px;font-size:10px;letter-spacing:.5px;font-weight:500;white-space:nowrap;}
.sinal-comprar{background:#00f5a018;color:#00f5a0;border:1px solid #00f5a030;}
.sinal-neutro{background:#fbbf2418;color:#fbbf24;border:1px solid #fbbf2430;}
.sinal-aguardar{background:#f8717118;color:#f87171;border:1px solid #f8717130;}
.sinal-na{background:#4d6b7018;color:#4d6b70;border:1px solid #4d6b7030;}
.sinal-loading{color:var(--muted);font-size:11px;}
.indicador-val{font-size:11px;color:var(--muted);}
.indicador-val span{color:var(--text);}
.src-badge{display:inline-block;font-size:9px;letter-spacing:1px;padding:1px 5px;border-radius:2px;vertical-align:middle;margin-left:4px;}
.src-auto{background:#38bdf812;color:#38bdf8;}
.src-manual{background:#fb923c12;color:#fb923c;}
.btn-refresh{
  background:none;border:1px solid var(--border);color:var(--muted);
  font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;
  text-transform:uppercase;padding:6px 14px;border-radius:3px;cursor:pointer;transition:all .2s;
  display:flex;align-items:center;gap:6px;
}
.btn-refresh:hover{border-color:var(--green);color:var(--green);}
.btn-refresh.loading{opacity:.5;pointer-events:none;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê AUTH ‚ïê‚ïê -->
<div id="auth-screen">
  <div class="auth-wrap">
    <div class="auth-brand">
      <div class="auth-brand-logo">Portf√≥lio+</div>
      <div class="auth-brand-tagline">Controle inteligente<br>de investimentos</div>
      <div class="auth-brand-feat">
        <div class="auth-feat-item">
          <div class="auth-feat-icon fi-green">üìã</div>
          Cole direto do Excel ‚Äî sem digitar nada
        </div>
        <div class="auth-feat-item">
          <div class="auth-feat-icon fi-blue">‚ö°</div>
          Pre√ßos buscados automaticamente
        </div>
        <div class="auth-feat-item">
          <div class="auth-feat-icon fi-purple">üìä</div>
          Gr√°ficos e comparativos por m√™s
        </div>
      </div>
    </div>
    <div class="auth-box">
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchTab('login')">Entrar</button>
        <button class="auth-tab" onclick="switchTab('cadastro')">Cadastrar</button>
      </div>
      <div id="tab-login">
        <div class="fg"><label>E-mail</label><input type="email" id="login-email" placeholder="seu@email.com"></div>
        <div class="fg"><label>Senha</label><input type="password" id="login-senha" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
        <button class="btn-auth" onclick="doLogin()">Entrar</button>
        <div class="auth-err" id="login-err"></div>
      </div>
      <div id="tab-cad" style="display:none">
        <div class="fg"><label>Nome</label><input type="text" id="cad-nome" placeholder="Seu nome"></div>
        <div class="fg"><label>E-mail</label><input type="email" id="cad-email" placeholder="seu@email.com"></div>
        <div class="fg"><label>Senha</label><input type="password" id="cad-senha" placeholder="M√≠nimo 6 caracteres"></div>
        <button class="btn-auth" onclick="doCadastro()">Criar conta</button>
        <div class="auth-err" id="cad-err"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<div id="app-screen">
  <div class="topbar">
    <div class="topbar-logo">Portf√≥lio+</div>
    <div class="topbar-right">
      <span class="topbar-user" id="user-nome"></span>
      <button class="btn-out" onclick="doLogout()">Sair</button>
    </div>
  </div>

  <div class="main">

    <!-- ‚îÄ‚îÄ ZONA DE IMPORTA√á√ÉO ‚îÄ‚îÄ -->
    <div class="paste-section">
      <div class="section-eyebrow">Adicionar ativos</div>

      <div class="manual-toggle" id="paste-toggle" onclick="togglePaste()">
        <span class="arrow" id="paste-arrow" style="transform:rotate(90deg)">‚ñ∂</span>
        <span>Colar da Planilha</span>
      </div>

      <div id="paste-zone-wrap">
      <div class="paste-zone" id="paste-zone">
        <div class="paste-header">
          <div class="paste-title">Colar da Planilha</div>
          <div class="paste-hint">
            Na planilha, selecione <strong>duas colunas</strong>: a do ticker e a das cotas.<br>
            Copie com <strong>Ctrl+C</strong> e clique aqui para colar com <strong>Ctrl+V</strong>.
          </div>
        </div>
        <div class="paste-date-row">
          <label>M√™s de refer√™ncia:</label>
          <input type="month" id="paste-mes">
        </div>
        <div class="paste-body">
          <div class="drop-target" id="drop-target" onclick="focusPaste()" tabindex="0" onkeydown="if(event.key==='v'&&(event.ctrlKey||event.metaKey))focusPaste()">
            <textarea id="paste-input" tabindex="-1"></textarea>
            <div class="drop-icon">üìã</div>
            <div class="drop-label">
              Clique aqui e pressione <strong>Ctrl+V</strong><br>para colar sua planilha
            </div>
            <div class="drop-sub">Funciona com Excel, Google Sheets e Numbers</div>
          </div>
        </div>

        <!-- PREVIEW -->
        <div id="preview-wrap">
          <div style="padding:0 24px 12px;">
            <div class="preview-bar">
              <div class="preview-count" id="preview-count"></div>
              <div class="preview-actions">
                <button class="btn-cancel" onclick="cancelarPreview()">‚úï Cancelar</button>
                <button class="btn-save" id="btn-save" onclick="salvarTodos()">‚úì Salvar todos</button>
              </div>
            </div>
          </div>
          <div style="padding:0 24px;">
            <table class="ptable">
              <thead><tr>
                <th>Ticker</th><th>Cotas</th><th>Pre√ßo atual</th><th>Total</th><th>Valor manual (R$)</th><th>Tipo</th>
              </tr></thead>
              <tbody id="preview-body"></tbody>
            </table>
          </div>
          <div class="err-msg" id="preview-err"></div>
        </div>
      </div>
      </div><!-- /paste-zone-wrap -->

      <!-- MANUAL (dobrado) -->
      <div style="margin-top:12px;">
        <div class="manual-toggle" id="manual-toggle" onclick="toggleManual()">
          <span class="arrow">‚ñ∂</span>
          <span>Ou adicionar um ativo manualmente</span>
        </div>
        <div class="manual-form" id="manual-form">
          <div class="mrow">
            <div class="fg"><label>Nome / Ticker</label><input type="text" id="m-nome" placeholder="Ex: MXRF11, Tesouro IPCA+"></div>
            <div class="fg"><label>Tipo</label>
              <select id="m-tipo">
                <option value="fii">FII</option>
                <option value="acoes">A√ß√µes</option>
                <option value="etf">ETF</option>
                <option value="renda-fixa">Renda Fixa</option>
                <option value="crypto">Crypto</option>
                <option value="outro">Outro</option>
              </select>
            </div>
            <div class="fg"><label>Valor total (R$)</label><input type="number" id="m-valor" placeholder="0,00" min="0" step="0.01"></div>
            <div class="fg"><label>M√™s/Ano</label><input type="month" id="m-mes"></div>
            <button class="btn-madd" onclick="addManual()">+ Add</button>
          </div>
          <div class="auth-err" id="m-err" style="text-align:left;margin-top:10px;padding:0;"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ GR√ÅFICOS ‚îÄ‚îÄ -->
    <div class="manual-toggle" id="tog-graficos" onclick="toggleSection('graficos')" style="margin-bottom:12px;margin-top:8px;">
      <span class="arrow" id="arr-graficos" style="transform:rotate(90deg)">‚ñ∂</span>
      <span>Gr√°ficos</span>
    </div>
    <div class="section-body" id="graficos">
    <div class="charts-grid">
      <div class="chart-card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
          <div class="chart-ey" style="margin:0">Distribui√ß√£o</div>
          <div class="chart-types">
            <button class="btn-ctype active" id="ct-dist-donut"   onclick="setChartType('dist','doughnut')">Donut</button>
            <button class="btn-ctype"        id="ct-dist-pie"     onclick="setChartType('dist','pie')">Pizza</button>
            <button class="btn-ctype"        id="ct-dist-bar"     onclick="setChartType('dist','bar')">Barras</button>
            <button class="btn-ctype"        id="ct-dist-polar"   onclick="setChartType('dist','polarArea')">Polar</button>
          </div>
        </div>
        <canvas id="chart-pizza" height="200"></canvas>
      </div>
      <div class="chart-card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
          <div class="chart-ey" style="margin:0">Evolu√ß√£o</div>
          <div class="chart-types">
            <button class="btn-ctype active" id="ct-evol-bar"    onclick="setChartType('evol','bar')">Barras</button>
            <button class="btn-ctype"        id="ct-evol-line"   onclick="setChartType('evol','line')">Linha</button>
            <button class="btn-ctype"        id="ct-evol-area"   onclick="setChartType('evol','area')">√Årea</button>
            <button class="btn-ctype"        id="ct-evol-anual"  onclick="setChartType('evol','anual')">Anual</button>
          </div>
        </div>
        <canvas id="chart-barras" height="200"></canvas>
      </div>
    </div>
    </div>

    <!-- ‚îÄ‚îÄ LISTA ‚îÄ‚îÄ -->
    <div class="manual-toggle" id="tog-lista-wrap" onclick="toggleSection('lista-wrap')" style="margin-bottom:12px;margin-top:8px;">
      <span class="arrow" id="arr-lista-wrap" style="transform:rotate(90deg)">‚ñ∂</span>
      <span>Carteira</span>
    </div>
    <div class="section-body" id="lista-wrap">
    <div class="list-head-bar">
      <div class="filter-wrap">
        <label>Filtrar:</label>
        <select id="filtro-mes" onchange="renderLista()"><option value="">Todos os meses</option></select>
      </div>
      <div style="display:flex;gap:10px;">
        <button class="btn-refresh" id="btn-refresh" onclick="atualizarSinais()">
          <span id="refresh-icon">‚Üª</span> Atualizar sinais
        </button>
        <button class="btn-refresh" style="border-color:var(--red);color:var(--red);" onclick="confirmarApagarTudo()">
          üóë Apagar tudo
        </button>
      </div>
    </div>
    <div class="list-card">
      <div class="list-hdr">
        <span id="sh-nome"    onclick="sortBy('nome')"   ><span>Ativo</span>      <span class="sort-arrow" id="sa-nome"></span></span>
        <span id="sh-tipo"    onclick="sortBy('tipo')"   ><span>Tipo</span>       <span class="sort-arrow" id="sa-tipo"></span></span>
        <span id="sh-cotas"   onclick="sortBy('cotas')"  ><span>Cotas</span>      <span class="sort-arrow" id="sa-cotas"></span></span>
        <span id="sh-pmedio"  onclick="sortBy('pmedio')" ><span>Pre√ßo/cota</span><span class="sort-arrow" id="sa-pmedio"></span></span>
        <span id="sh-valor"   onclick="sortBy('valor')"  ><span>Valor total</span><span class="sort-arrow" id="sa-valor"></span></span>
        <span id="sh-ind"     onclick="sortBy('ind')"    ><span>Indicador</span>  <span class="sort-arrow" id="sa-ind"></span></span>
        <span id="sh-sinal"   onclick="sortBy('sinal')"  ><span>Sinal</span>      <span class="sort-arrow" id="sa-sinal"></span></span>
        <span></span>
      </div>
      <div id="lista"><div class="loading-msg">Carregando...</div></div>
      <div class="total-row">
        <span class="total-lbl">Total</span>
        <span class="total-num" id="total">R$ 0,00</span>
      </div>
    </div>
    </div><!-- /lista-wrap -->

  </div>
</div>

<script>
const WORKER = 'https://financas.crlages.workers.dev';
let user = null, dados = [], cP = null, cB = null, previewRows = [];

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
async function sha(s){const b=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');}
function R(s){return'R$ '+Number(s).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});}
async function api(action,body){try{const r=await fetch(WORKER,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action,...body})});return await r.json();}catch{return{error:'Sem conex√£o com o servidor.'};}}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function switchTab(t){
  document.querySelectorAll('.auth-tab').forEach((el,i)=>el.classList.toggle('active',(i===0&&t==='login')||(i===1&&t==='cadastro')));
  document.getElementById('tab-login').style.display=t==='login'?'':'none';
  document.getElementById('tab-cad').style.display=t==='cadastro'?'':'none';
}
async function doCadastro(){
  const nome=document.getElementById('cad-nome').value.trim(),email=document.getElementById('cad-email').value.trim(),senha=document.getElementById('cad-senha').value;
  const err=document.getElementById('cad-err');err.textContent='';
  if(!nome||!email||!senha)return err.textContent='Preencha todos os campos.';
  if(senha.length<6)return err.textContent='Senha m√≠nimo 6 caracteres.';
  const r=await api('cadastro',{nome,email,senha:await sha(senha)});
  if(r.error)return err.textContent=r.error;
  user=r.user;entrar();
}
async function doLogin(){
  const email=document.getElementById('login-email').value.trim(),senha=document.getElementById('login-senha').value;
  const err=document.getElementById('login-err');err.textContent='';
  if(!email||!senha)return err.textContent='Preencha e-mail e senha.';
  const r=await api('login',{email,senha:await sha(senha)});
  if(r.error)return err.textContent=r.error;
  user=r.user;entrar();
}
function doLogout(){user=null;dados=[];document.getElementById('app-screen').style.display='none';document.getElementById('auth-screen').style.display='flex';}
function entrar(){
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('app-screen').style.display='block';
  document.getElementById('user-nome').textContent=user.nome;
  document.getElementById('m-mes').value=new Date().toISOString().slice(0,7);
  document.getElementById('paste-mes').value=new Date().toISOString().slice(0,7);
  carregar();
}

// ‚îÄ‚îÄ PASTE ZONE ‚îÄ‚îÄ
function focusPaste(){
  const inp=document.getElementById('paste-input');
  inp.value='';inp.focus();
}

document.addEventListener('DOMContentLoaded',()=>{
  const inp=document.getElementById('paste-input');
  const drop=document.getElementById('drop-target');

  inp.addEventListener('paste',e=>{
    e.preventDefault();
    const txt=e.clipboardData.getData('text');
    processarTexto(txt);
  });

  // suporte a drag-over visual
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag-over');});
  drop.addEventListener('dragleave',()=>drop.classList.remove('drag-over'));
  drop.addEventListener('drop',e=>{
    e.preventDefault();drop.classList.remove('drag-over');
    const txt=e.dataTransfer.getData('text');
    if(txt)processarTexto(txt);
  });
});

// ‚îÄ‚îÄ PARSEAR TEXTO COLADO ‚îÄ‚îÄ
function processarTexto(txt){
  if(!txt||!txt.trim())return;
  const linhas=txt.trim().split('\n').map(l=>l.trim()).filter(Boolean);
  const ativos=[];
  for(const linha of linhas){
    // separador pode ser TAB (padr√£o do Excel), ; ou m√∫ltiplos espa√ßos
    const partes=linha.split(/\t|;/).map(p=>p.replace(/[^\w.,\-]/g,'').trim()).filter(Boolean);
    if(partes.length<2)continue;
    const ticker=partes[0].toUpperCase();
    const cotas=parseFloat(partes[1].replace(',','.'));
    if(!ticker||isNaN(cotas)||cotas<=0)continue;
    ativos.push({ticker,cotas,tipo:detectarTipo(ticker)});
  }
  if(!ativos.length){
    document.getElementById('preview-err').textContent='N√£o encontrei dados v√°lidos. Verifique se copiou duas colunas (Ticker | Cotas).';
    return;
  }
  mostrarPreview(ativos);
}

function detectarTipo(t){
  const etfs=['BOVA11','SMAL11','IVVB11','HASH11','GOLD11','DIVO11','SPXI11','NASD11','ACWI11','BBOV11'];
  if(t.includes('-'))return'crypto';
  if(etfs.includes(t))return'etf';
  if(t.match(/11$/))return'fii';
  if(t.match(/^[A-Z]{4}\d{1,2}$/))return'acoes';
  return'outro';
}

// ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ
function mostrarPreview(ativos){
  document.getElementById('drop-target').style.display='none';
  document.getElementById('preview-wrap').style.display='block';
  document.getElementById('preview-err').textContent='';
  document.getElementById('btn-save').disabled=true;
  document.getElementById('preview-count').textContent=`${ativos.length} ativo${ativos.length>1?'s':''} detectado${ativos.length>1?'s':''}`;

  const tipoOpts=sel=>`
    <option value="fii"${sel==='fii'?' selected':''}>FII</option>
    <option value="acoes"${sel==='acoes'?' selected':''}>A√ß√µes</option>
    <option value="etf"${sel==='etf'?' selected':''}>ETF</option>
    <option value="renda-fixa"${sel==='renda-fixa'?' selected':''}>Renda Fixa</option>
    <option value="crypto"${sel==='crypto'?' selected':''}>Crypto</option>
    <option value="outro"${sel==='outro'?' selected':''}>Outro</option>`;

  previewRows=ativos.map(a=>({...a,preco:null,total:null,err:false}));

  document.getElementById('preview-body').innerHTML=ativos.map((a,i)=>`
    <tr>
      <td class="ticker-cell">${a.ticker}</td>
      <td class="cotas-cell">${a.cotas.toLocaleString('pt-BR')}</td>
      <td id="pp-${i}"><span class="price-loading"><span class="spin">‚ü≥</span> buscando...</span></td>
      <td id="pt-${i}" style="color:var(--muted)">‚Äî</td>
      <td><input type="number" id="pv-${i}" class="manual-val-input" placeholder="digitar" min="0" step="0.01" oninput="onManualValor(${i})"></td>
      <td><select class="tipo-sel" id="ptp-${i}" onchange="previewRows[${i}].tipo=this.value">${tipoOpts(a.tipo)}</select></td>
    </tr>`).join('');

  // buscar todos os pre√ßos de uma vez pelo Worker
  buscarTodosPrecos(ativos.map(a=>a.ticker)).then(precos=>{
    ativos.forEach((a,i)=>{
      const preco=precos[a.ticker];
      if(preco){
        const total=preco*a.cotas;
        previewRows[i].preco=preco;previewRows[i].total=total;
        document.getElementById(`pp-${i}`).innerHTML=`<span class="price-ok">${R(preco)}</span>`;
        document.getElementById(`pt-${i}`).innerHTML=`<span class="total-ok">${R(total)}</span>`;
      }else{
        previewRows[i].err=true;
        document.getElementById(`pp-${i}`).innerHTML=`<span class="price-err">‚úó n√£o encontrado</span>`;
        document.getElementById(`pt-${i}`).textContent='‚Äî';
      }
    });
    document.getElementById('btn-save').disabled=false;
  });
}

function onManualValor(i){
  const val=parseFloat(document.getElementById(`pv-${i}`).value);
  if(!isNaN(val)&&val>0){
    previewRows[i].total=val;
    previewRows[i].err=false;
    document.getElementById(`pt-${i}`).innerHTML=`<span class="total-ok">${R(val)}</span>`;
  }else{
    // se apagou, volta ao estado anterior (pre√ßo do yahoo ou erro)
    if(previewRows[i].preco){
      const total=previewRows[i].preco*previewRows[i].cotas;
      previewRows[i].total=total;
      previewRows[i].err=false;
      document.getElementById(`pt-${i}`).innerHTML=`<span class="total-ok">${R(total)}</span>`;
    }else{
      previewRows[i].total=null;
      previewRows[i].err=true;
      document.getElementById(`pt-${i}`).textContent='‚Äî';
    }
  }
}

// Busca todos os pre√ßos de uma vez pelo Worker (sem CORS, sem proxy)
async function buscarTodosPrecos(tickers){
  try{
    const r=await api('preco',{tickers});
    return r.precos||{};
  }catch{return{};}
}

function cancelarPreview(){
  document.getElementById('preview-wrap').style.display='none';
  document.getElementById('drop-target').style.display='flex';
  document.getElementById('paste-input').value='';
  previewRows=[];
}

async function salvarTodos(){
  const btn=document.getElementById('btn-save');
  btn.disabled=true;btn.textContent='Salvando...';
  const mesVal=document.getElementById('paste-mes').value||new Date().toISOString().slice(0,7);
  const [anoStr,mStr]=mesVal.split('-');const m=parseInt(mStr),ano=parseInt(anoStr);
  const validos=previewRows.filter(r=>!r.err&&r.total>0);

  // Recarrega dados frescos do banco antes de comparar (evita merge com cache desatualizado)
  const dadosFrescos=(await api('listar',{usuario_id:user.id})).investimentos||[];

  for(const r of validos){
    const fonte=r.preco?'auto':'manual';
    // Procura existente com mesmo ticker + mes + ano no banco atual
    const existente=dadosFrescos.find(d=>
      d.nome.toUpperCase()===r.ticker.toUpperCase()&&
      Number(d.mes)===m&&
      Number(d.ano)===ano
    );
    if(existente){
      // Soma cotas e valor ao registro existente
      const novasCotas=(Number(existente.cotas)||0)+(Number(r.cotas)||0);
      const novoValor=Number(existente.valor)+Number(r.total);
      await api('atualizar',{id:existente.id,usuario_id:user.id,cotas:novasCotas,valor:novoValor});
    }else{
      await api('adicionar',{usuario_id:user.id,nome:r.ticker,tipo:r.tipo,valor:r.total,cotas:r.cotas,mes:m,ano,fonte});
    }
  }
  cancelarPreview();
  btn.textContent='‚úì Salvar todos';
  await carregar();
}

// ‚îÄ‚îÄ MANUAL ‚îÄ‚îÄ
function togglePaste(){
  const wrap=document.getElementById('paste-zone-wrap');
  const arrow=document.getElementById('paste-arrow');
  const toggle=document.getElementById('paste-toggle');
  const isOpen=wrap.style.display!=='none';
  wrap.style.display=isOpen?'none':'block';
  arrow.style.transform=isOpen?'':'rotate(90deg)';
  toggle.classList.toggle('open',!isOpen);
}

function toggleManual(){
  const t=document.getElementById('manual-toggle'),f=document.getElementById('manual-form');
  t.classList.toggle('open');f.classList.toggle('open');
}
async function addManual(){
  const nome=document.getElementById('m-nome').value.trim();
  const tipo=document.getElementById('m-tipo').value;
  const valor=parseFloat(document.getElementById('m-valor').value);
  const mes=document.getElementById('m-mes').value;
  const err=document.getElementById('m-err');err.textContent='';
  if(!nome||!mes||isNaN(valor)||valor<=0)return err.textContent='Preencha todos os campos.';
  const[ano,m]=mes.split('-').map(Number);
  const r=await api('adicionar',{usuario_id:user.id,nome,tipo,valor,mes:m,ano,fonte:'manual'});
  if(r.error)return err.textContent=r.error;
  document.getElementById('m-nome').value='';document.getElementById('m-valor').value='';
  await carregar();
}

// ‚îÄ‚îÄ DADOS ‚îÄ‚îÄ
async function confirmarApagarTudo(){
  if(!confirm('Tem certeza? Isso apagar√° TODOS os investimentos cadastrados. Esta a√ß√£o n√£o pode ser desfeita.'))return;
  const res=await api('apagarTudo',{usuario_id:user.id});
  if(res.error)return alert('Erro: '+res.error);
  await carregar();
}

async function carregar(){
  const r=await api('listar',{usuario_id:user.id});
  dados=r.investimentos||[];
  populaFiltro();renderLista();renderGraficos();
  atualizarSinais();
}
async function deletar(id){await api('deletar',{id,usuario_id:user.id});await carregar();}

// ‚îÄ‚îÄ ORDENA√á√ÉO ‚îÄ‚îÄ
let sortCol='nome', sortDir=1, cacheSinais={};
// Mapeamento sinal ‚Üí peso num√©rico para ordenar
const SINAL_PESO={comprar:0,neutro:1,aguardar:2,na:3};

function sortBy(col){
  if(sortCol===col) sortDir*=-1;
  else{sortCol=col;sortDir=1;}
  // limpa headers
  document.querySelectorAll('.sort-arrow').forEach(el=>el.textContent='');
  document.querySelectorAll('.list-hdr span[id^="sh-"]').forEach(el=>el.classList.remove('sorted'));
  const arrow=document.getElementById('sa-'+col);
  const hdr  =document.getElementById('sh-'+col);
  if(arrow) arrow.textContent = sortDir===1 ? ' ‚Üë' : ' ‚Üì';
  if(hdr)   hdr.classList.add('sorted');
  renderLista();
}

function getSinalPeso(id){
  const el=document.getElementById('sig-'+id);
  if(!el) return 99;
  const txt=el.textContent.toLowerCase();
  if(txt.includes('comprar')) return 0;
  if(txt.includes('neutro'))  return 1;
  if(txt.includes('aguardar'))return 2;
  return 3;
}

function getIndVal(id){
  const el=document.getElementById('ind-'+id);
  if(!el) return null;
  const txt=el.textContent.replace(/[^0-9.,]/g,'').replace(',','.');
  const v=parseFloat(txt);
  return isNaN(v)?null:v;
}

async function atualizarSinais(){
  const btn=document.getElementById('btn-refresh');
  if(btn){btn.classList.add('loading');document.getElementById('refresh-icon').textContent='‚ü≥';}

  // pegar tickers √∫nicos que t√™m an√°lise (fii e acoes)
  const filtro=document.getElementById('filtro-mes').value;
  let dRaw=dados;
  if(filtro){const[fa,fm]=filtro.split('-').map(Number);dRaw=dRaw.filter(i=>Number(i.ano)===fa&&Number(i.mes)===fm);}
  const d=filtro?dRaw:consolidar(dRaw);

  const analisaveis=d.filter(i=>i.tipo==='fii'||i.tipo==='acoes');
  const tickers=[...new Set(analisaveis.map(i=>i.nome))];

  if(tickers.length>0){
    const res=await api('fundamentus',{tickers});
    if(res.dados) Object.assign(cacheSinais,res.dados);
  }

  // renderizar sinais para todos os itens vis√≠veis
  d.forEach(inv=>{
    const indEl=document.getElementById('ind-'+inv.id);
    const sigEl=document.getElementById('sig-'+inv.id);
    if(!indEl||!sigEl)return;

    if(inv.tipo==='fii'){
      const fd=cacheSinais[inv.nome];
      if(!fd||fd.pvp==null){
        indEl.innerHTML='<span class="indicador-val" style="color:var(--muted2)">‚Äî</span>';
        sigEl.innerHTML='<span class="sinal sinal-na">sem dados</span>';return;
      }
      const pvp=fd.pvp;
      const dyStr=fd.dy!=null?` ¬∑ DY ${fd.dy.toFixed(1)}%`:'';
      indEl.innerHTML=`<span class="indicador-val" title="P/VP: mede pre√ßo vs patrim√¥nio. Abaixo de 1 = descontado">P/VP <span>${pvp.toFixed(2)}</span>${dyStr}</span>`;
      if(pvp<0.95)       sigEl.innerHTML='<span class="sinal sinal-comprar">üü¢ Comprar</span>';
      else if(pvp<=1.05) sigEl.innerHTML='<span class="sinal sinal-neutro">üü° Neutro</span>';
      else               sigEl.innerHTML='<span class="sinal sinal-aguardar">üî¥ Aguardar</span>';

    }else if(inv.tipo==='acoes'){
      const fd=cacheSinais[inv.nome];
      if(!fd){
        indEl.innerHTML='<span class="indicador-val" style="color:var(--muted2)">‚Äî</span>';
        sigEl.innerHTML='<span class="sinal sinal-na">sem dados</span>';return;
      }
      const pl=fd.pl;
      const roeStr=fd.roe!=null?` ¬∑ ROE ${(fd.roe*100).toFixed(0)}%`:'';
      if(!pl||pl<=0){
        indEl.innerHTML=`<span class="indicador-val" title="P/L negativo indica preju√≠zo">P/L <span style="color:var(--red)">neg.</span>${roeStr}</span>`;
        sigEl.innerHTML='<span class="sinal sinal-aguardar">üî¥ Aguardar</span>';return;
      }
      indEl.innerHTML=`<span class="indicador-val" title="P/L: quantos anos de lucro valem o pre√ßo">P/L <span>${pl.toFixed(1)}</span>${roeStr}</span>`;
      if(pl<10)       sigEl.innerHTML='<span class="sinal sinal-comprar">üü¢ Comprar</span>';
      else if(pl<=20) sigEl.innerHTML='<span class="sinal sinal-neutro">üü° Neutro</span>';
      else            sigEl.innerHTML='<span class="sinal sinal-aguardar">üî¥ Aguardar</span>';

    }else{
      indEl.innerHTML='<span class="indicador-val" style="color:var(--muted2)">N/A</span>';
      sigEl.innerHTML='<span class="sinal sinal-na">holder</span>';
    }
  });

  if(btn){btn.classList.remove('loading');document.getElementById('refresh-icon').textContent='‚Üª';}
}

// ‚îÄ‚îÄ LISTA ‚îÄ‚îÄ
const TL={fii:'FII',acoes:'A√ß√µes',etf:'ETF','renda-fixa':'Renda Fixa',crypto:'Crypto',outro:'Outro'};
const TIPO_ORDER=['fii','acoes','etf','renda-fixa','crypto','outro'];

function consolidar(lista){
  // Agrupa por nome+tipo, somando cotas e valor (vis√£o "Todos os meses")
  const mapa={};
  lista.forEach(inv=>{
    const k=inv.nome+'|'+inv.tipo;
    if(!mapa[k]){
      mapa[k]={
        // id virtual para os elementos DOM (usa o do primeiro registro)
        id: inv.id,
        nome: inv.nome, tipo: inv.tipo, fonte: inv.fonte,
        cotas: Number(inv.cotas)||0,
        valor: Number(inv.valor)||0,
        _ids: [inv.id], // ids reais para deletar tudo
      };
    } else {
      mapa[k].cotas += Number(inv.cotas)||0;
      mapa[k].valor += Number(inv.valor)||0;
      mapa[k]._ids.push(inv.id);
    }
  });
  return Object.values(mapa);
}

async function deletarConsolidado(idsJson){
  const ids=JSON.parse(idsJson);
  for(const id of ids) await api('deletar',{id,usuario_id:user.id});
  await carregar();
}

function getSP(inv){
  const fd=cacheSinais[inv.nome];
  if(!fd) return 3;
  if(inv.tipo==='fii'){const v=fd.pvp;if(!v)return 3;return v<0.95?0:v<=1.05?1:2;}
  if(inv.tipo==='acoes'){const v=fd.pl;if(!v||v<=0)return 2;return v<10?0:v<=20?1:2;}
  return 3;
}

function renderLista(){
  const filtro=document.getElementById('filtro-mes').value;
  let raw=[...dados];

  // Com filtro de m√™s: mostra registros daquele m√™s (sem consolidar)
  // Sem filtro (Todos os meses): consolida somando cotas e valor por ativo
  let d, modoConsolidado;
  if(filtro){
    const[fa,fm]=filtro.split('-').map(Number);
    d=raw.filter(i=>Number(i.ano)===fa&&Number(i.mes)===fm);
    modoConsolidado=false;
  } else {
    d=consolidar(raw);
    modoConsolidado=true;
  }

  const el=document.getElementById('lista');
  if(!d.length){
    el.innerHTML='<div class="empty"><strong>üìä</strong>Nenhum ativo registrado ainda.<br>Cole sua planilha acima para come√ßar.</div>';
    document.getElementById('total').textContent='R$ 0,00';return;
  }

  // ‚îÄ‚îÄ Ordenar ‚îÄ‚îÄ
  d.sort((a,b)=>{
    const ca=a.cotas?Number(a.cotas):null;
    const cb=b.cotas?Number(b.cotas):null;
    const pma=ca&&ca>0?a.valor/ca:null;
    const pmb=cb&&cb>0?b.valor/cb:null;
    if(sortCol==='nome')  {return sortDir*(a.nome<b.nome?-1:a.nome>b.nome?1:0);}
    if(sortCol==='tipo')  {return sortDir*(TIPO_ORDER.indexOf(a.tipo)-TIPO_ORDER.indexOf(b.tipo));}
    if(sortCol==='cotas') {return sortDir*((cb??-1)-(ca??-1));}
    if(sortCol==='pmedio'){return sortDir*((pmb??-1)-(pma??-1));}
    if(sortCol==='valor') {return sortDir*(b.valor-a.valor);}
    if(sortCol==='ind'){
      const ga=(a.tipo==='fii'?cacheSinais[a.nome]?.pvp:cacheSinais[a.nome]?.pl)??999;
      const gb=(b.tipo==='fii'?cacheSinais[b.nome]?.pvp:cacheSinais[b.nome]?.pl)??999;
      return sortDir*(ga-gb);
    }
    if(sortCol==='sinal'){return sortDir*(getSP(a)-getSP(b));}
    return 0;
  });

  // ‚îÄ‚îÄ Renderizar ‚îÄ‚îÄ
  let html='', lastGroup=null;
  d.forEach(inv=>{
    const cotas=inv.cotas?Number(inv.cotas):null;
    const pmedio=cotas&&cotas>0?inv.valor/cotas:null;
    const idsJson=JSON.stringify(inv._ids||[inv.id]);

    // Separadores de grupo
    if(sortCol==='tipo'){
      const g=TL[inv.tipo]||inv.tipo;
      if(g!==lastGroup){lastGroup=g;html+=`<div class="group-sep">${g}</div>`;}
    } else if(sortCol==='sinal'){
      const fd=cacheSinais[inv.nome];let g='Holder';
      if(inv.tipo==='fii'||inv.tipo==='acoes'){
        const v=inv.tipo==='fii'?fd?.pvp:fd?.pl;
        if(v!=null) g=v<(inv.tipo==='fii'?0.95:10)?'üü¢ Comprar':v<=(inv.tipo==='fii'?1.05:20)?'üü° Neutro':'üî¥ Aguardar';
        else g='Sem dados';
      }
      if(g!==lastGroup){lastGroup=g;html+=`<div class="group-sep">${g}</div>`;}
    } else { lastGroup=null; }

    html+=`
    <div class="list-row">
      <span class="list-ticker">${inv.nome} <span class="src-badge ${inv.fonte==='manual'?'src-manual':'src-auto'}">${inv.fonte==='manual'?'manual':'auto'}</span></span>
      <span><span class="badge b-${inv.tipo}">${TL[inv.tipo]||inv.tipo}</span></span>
      <span style="color:var(--muted);font-size:12px;">${cotas?cotas.toLocaleString('pt-BR'):'‚Äî'}</span>
      <span style="color:var(--muted);font-size:12px;">${pmedio?R(pmedio):'‚Äî'}</span>
      <span class="list-val">${R(inv.valor)}</span>
      <span class="indicador-val" id="ind-${inv.id}"><span class="sinal-loading">‚Äî</span></span>
      <span id="sig-${inv.id}"><span class="sinal-loading">‚Äî</span></span>
      <button class="btn-del" onclick="deletarConsolidado('${idsJson.replace(/'/g,"\'")}')" title="${modoConsolidado?'Remove todos os registros deste ativo':'Remove este registro'}">‚úï</button>
    </div>`;
  });

  el.innerHTML=html;
  document.getElementById('total').textContent=R(d.reduce((s,i)=>s+i.valor,0));
}

// ‚îÄ‚îÄ SE√á√ïES COLAPS√ÅVEIS ‚îÄ‚îÄ
function toggleSection(id){
  const body=document.getElementById(id);
  const arr=document.getElementById('arr-'+id);
  if(!body)return;
  const collapsed=body.classList.toggle('collapsed');
  if(arr)arr.style.transform=collapsed?'':'rotate(90deg)';
}

// ‚îÄ‚îÄ GR√ÅFICOS MULTI-TIPO ‚îÄ‚îÄ
let chartDistType='doughnut', chartEvolType='bar';

function setChartType(grupo, tipo){
  if(grupo==='dist'){
    chartDistType=tipo;
    document.querySelectorAll('[id^="ct-dist-"]').forEach(b=>b.classList.remove('active'));
    const id=tipo==='doughnut'?'donut':tipo==='polarArea'?'polar':tipo;
    const btn=document.getElementById('ct-dist-'+id);
    if(btn)btn.classList.add('active');
  } else {
    chartEvolType=tipo;
    document.querySelectorAll('[id^="ct-evol-"]').forEach(b=>b.classList.remove('active'));
    const id=tipo==='anual'?'anual':tipo;
    const btn=document.getElementById('ct-evol-'+id);
    if(btn)btn.classList.add('active');
  }
  renderGraficos();
}

function renderGraficos(){
  const cores=['#38bdf8','#00f5a0','#fbbf24','#fb923c','#a78bfa','#4d6b70'];
  const scalesOpts={
    x:{ticks:{color:'#4d6b70',font:{family:'JetBrains Mono',size:10}},grid:{color:'#161c1e'}},
    y:{ticks:{color:'#4d6b70',font:{family:'JetBrains Mono',size:10},callback:v=>'R$'+v.toLocaleString('pt-BR')},grid:{color:'#161c1e'}}
  };

  // ‚îÄ‚îÄ Distribui√ß√£o ‚îÄ‚îÄ
  const tipos={};dados.forEach(i=>tipos[i.tipo]=(tipos[i.tipo]||0)+i.valor);
  const distLabels=Object.keys(tipos).map(k=>TL[k]||k);
  const distData=Object.values(tipos);
  if(cP)cP.destroy();
  const distType=chartDistType==='doughnut'||chartDistType==='pie'||chartDistType==='polarArea'?chartDistType:'bar';
  const distIsRadial=distType==='doughnut'||distType==='pie'||distType==='polarArea';
  cP=new Chart(document.getElementById('chart-pizza'),{
    type:distType,
    data:{
      labels:distLabels,
      datasets:[{
        data:distData,
        backgroundColor:cores,
        borderWidth:distIsRadial?0:2,
        borderColor:distIsRadial?undefined:cores,
        backgroundColor:distIsRadial?cores:cores.map(c=>c+'30'),
        hoverOffset:distIsRadial?6:0,
        borderRadius:distIsRadial?0:3,
      }]
    },
    options:{
      plugins:{
        legend:{labels:{color:'#4d6b70',font:{family:'JetBrains Mono',size:11},padding:14},display:distIsRadial},
        tooltip:{callbacks:{label:ctx=>` ${R(ctx.raw)}`}}
      },
      cutout:distType==='doughnut'?'68%':undefined,
      scales:distIsRadial?undefined:scalesOpts,
    }
  });

  // ‚îÄ‚îÄ Evolu√ß√£o ‚îÄ‚îÄ
  // Agrupa por m√™s ou por ano dependendo do tipo
  const isAnual=chartEvolType==='anual';
  const evolMap={};
  dados.forEach(i=>{
    const k=isAnual?String(i.ano):`${String(i.mes).padStart(2,'0')}/${i.ano}`;
    evolMap[k]=(evolMap[k]||0)+i.valor;
  });
  const evolKeys=Object.keys(evolMap).sort((a,b)=>{
    if(isAnual)return Number(a)-Number(b);
    const[ma,ya]=a.split('/');const[mb,yb]=b.split('/');
    return(Number(ya)*100+Number(ma))-(Number(yb)*100+Number(mb));
  });
  const evolData=evolKeys.map(k=>evolMap[k]);
  const isArea=chartEvolType==='area';
  const evolChartType=isArea||chartEvolType==='line'?'line':'bar';
  if(cB)cB.destroy();
  cB=new Chart(document.getElementById('chart-barras'),{
    type:evolChartType,
    data:{labels:evolKeys,datasets:[{
      label:'Total',
      data:evolData,
      backgroundColor:isArea?'#00f5a018':'#00f5a018',
      borderColor:'#00f5a0',
      borderWidth:2,
      borderRadius:evolChartType==='bar'?3:0,
      fill:isArea?'origin':false,
      tension:isArea||chartEvolType==='line'?0.4:0,
      pointBackgroundColor:'#00f5a0',
      pointRadius:evolChartType==='bar'?0:4,
    }]},
    options:{
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${R(ctx.raw)}`}}},
      scales:scalesOpts,
    }
  });
}

// ‚îÄ‚îÄ FILTRO ‚îÄ‚îÄ
function populaFiltro(){
  const sel=document.getElementById('filtro-mes'),atual=sel.value;
  const meses=[...new Set(dados.map(i=>`${i.ano}-${String(i.mes).padStart(2,'0')}`))].sort();
  sel.innerHTML='<option value="">Todos os meses</option>'+meses.map(m=>{const[a,ms]=m.split('-');return`<option value="${m}"${m===atual?' selected':''}>${ms}/${a}</option>`;}).join('');
}
</script>
</body>
</html>
